# ================================
# CALL FILTER DASHBOARD - SERVERLESS CONFIGURATION
# ================================
#
# Single environment (prod) configuration.
# Local dev uses serverless-offline on port 4000.
#
# DEPLOYMENT:
# 1. Create .env file from .env.example
# 2. Run local: npm run dev
# 3. Deploy: npm run deploy
# 4. Remove: npm run remove
#
# ================================

service: call-filter-server

frameworkVersion: ^4.0.0

provider:
  name: aws
  runtime: nodejs20.x
  stage: prod
  region: ${env:AWS_REGION}
  timeout: 30
  memorySize: 256

  # Log retention
  logRetentionInDays: 14

  # API Gateway configuration
  httpApi:
    cors:
      allowedOrigins:
        - ${self:custom.corsOrigin.${env:IS_LOCAL, 'false'}}
      allowedHeaders:
        - Content-Type
        - Authorization
      allowedMethods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      allowCredentials: true
      maxAge: 86400

    authorizers:
      cognitoAuthorizer:
        type: jwt
        identitySource: $request.header.Authorization
        issuerUrl:
          Fn::Sub: https://cognito-idp.${AWS::Region}.amazonaws.com/${CognitoUserPool}
        audience:
          - Ref: CognitoUserPoolClient

  # Environment variables for all functions
  environment:
    # Cognito - use env vars for local, CloudFormation Ref for prod
    COGNITO_USER_POOL_ID: ${env:COGNITO_USER_POOL_ID}
    COGNITO_CLIENT_ID: ${env:COGNITO_CLIENT_ID}
    # Twilio
    TWILIO_ACCOUNT_SID: ${env:TWILIO_ACCOUNT_SID}
    TWILIO_AUTH_TOKEN: ${env:TWILIO_AUTH_TOKEN}
    TWILIO_ASSET_SERVICE_SID: ${env:TWILIO_ASSET_SERVICE_SID}
    # CORS
    CORS_ORIGIN: ${self:custom.corsOrigin.${env:IS_LOCAL, 'false'}}
    # Environment flag
    IS_LOCAL: ${env:IS_LOCAL, 'false'}

  # IAM Role permissions
  iam:
    role:
      statements:
        # Cognito permissions
        - Effect: Allow
          Action:
            - cognito-idp:AdminInitiateAuth
            - cognito-idp:AdminGetUser
            - cognito-idp:AdminSetUserPassword
            - cognito-idp:ForgotPassword
            - cognito-idp:ConfirmForgotPassword
          Resource:
            - arn:aws:cognito-idp:${self:provider.region}:*:userpool/*

# Package configuration
package:
  individually: true
  patterns:
    - "!src/**"
    - "!node_modules/**"
    - "!.env*"
    - "!tsconfig.json"
    - "!README.md"
    - "package.json"

# Plugins
plugins:
  - serverless-offline

# Custom variables
custom:
  # CORS origin with protocol - conditional based on IS_LOCAL
  corsOrigin:
    true: http://localhost:3000
    false: https://${env:DOMAIN}

  # Serverless Offline - disable authorizers for local dev
  serverless-offline:
    httpPort: 4000
    noPrependStageInUrl: true
    reloadHandler: true
    noAuth: true

# Lambda Functions
functions:
  # ================================
  # AUTH FUNCTIONS
  # ================================

  login:
    handler: build/auth/login.handler
    description: Login with Cognito (email + password)
    package:
      patterns:
        - "!build/**"
        - "build/auth/login.mjs"
    events:
      - httpApi:
          path: /api/auth/login
          method: post

  refreshToken:
    handler: build/auth/refreshToken.handler
    description: Refresh access token using refresh token
    package:
      patterns:
        - "!build/**"
        - "build/auth/refreshToken.mjs"
    events:
      - httpApi:
          path: /api/auth/refresh
          method: post

  forgotPassword:
    handler: build/auth/forgotPassword.handler
    description: Initiate forgot password flow
    package:
      patterns:
        - "!build/**"
        - "build/auth/forgotPassword.mjs"
    events:
      - httpApi:
          path: /api/auth/forgot-password
          method: post

  resetPassword:
    handler: build/auth/resetPassword.handler
    description: Reset password with confirmation code
    package:
      patterns:
        - "!build/**"
        - "build/auth/resetPassword.mjs"
    events:
      - httpApi:
          path: /api/auth/reset-password
          method: post

  # ================================
  # CONFIG FUNCTIONS
  # ================================

  getConfig:
    handler: build/config/get.handler
    description: Get whitelist and schedule configuration
    package:
      patterns:
        - "!build/**"
        - "build/config/get.mjs"
    events:
      - httpApi:
          path: /api/config
          method: get
          authorizer:
            name: cognitoAuthorizer

  updateConfig:
    handler: build/config/update.handler
    description: Update whitelist and schedule configuration
    package:
      patterns:
        - "!build/**"
        - "build/config/update.mjs"
    events:
      - httpApi:
          path: /api/config
          method: put
          authorizer:
            name: cognitoAuthorizer

  # ================================
  # HEALTH CHECK
  # ================================

  health:
    handler: build/health.handler
    description: Health check endpoint
    package:
      patterns:
        - "!build/**"
        - "build/health.mjs"
    events:
      - httpApi:
          path: /api/health
          method: get

# AWS Resources
resources:
  Resources:
    # ================================
    # COGNITO USER POOL
    # ================================

    CognitoUserPool:
      Type: AWS::Cognito::UserPool
      Properties:
        UserPoolName: ${self:service}-prod
        UsernameAttributes:
          - email
        AutoVerifiedAttributes:
          - email
        Schema:
          - Name: email
            AttributeDataType: String
            Required: true
            Mutable: false
          - Name: name
            AttributeDataType: String
            Required: false
            Mutable: true
        Policies:
          PasswordPolicy:
            MinimumLength: 8
            RequireUppercase: true
            RequireLowercase: true
            RequireNumbers: true
            RequireSymbols: true
        EmailConfiguration:
          EmailSendingAccount: COGNITO_DEFAULT
        AccountRecoverySetting:
          RecoveryMechanisms:
            - Name: verified_email
              Priority: 1
        UserPoolAddOns:
          AdvancedSecurityMode: OFF

    CognitoUserPoolClient:
      Type: AWS::Cognito::UserPoolClient
      Properties:
        ClientName: ${self:service}-prod-client
        UserPoolId:
          Ref: CognitoUserPool
        GenerateSecret: false
        ExplicitAuthFlows:
          - ALLOW_USER_PASSWORD_AUTH
          - ALLOW_REFRESH_TOKEN_AUTH
          - ALLOW_ADMIN_USER_PASSWORD_AUTH
        PreventUserExistenceErrors: ENABLED
        EnableTokenRevocation: true
        AccessTokenValidity: 1
        IdTokenValidity: 1
        RefreshTokenValidity: 30
        TokenValidityUnits:
          AccessToken: hours
          IdToken: hours
          RefreshToken: days
        ReadAttributes:
          - email
          - name
          - email_verified
        WriteAttributes:
          - email
          - name

  # CloudFormation Outputs
  Outputs:
    CognitoUserPoolId:
      Description: Cognito User Pool ID
      Value:
        Ref: CognitoUserPool
      Export:
        Name: ${self:service}-prod-UserPoolId

    CognitoClientId:
      Description: Cognito User Pool Client ID
      Value:
        Ref: CognitoUserPoolClient
      Export:
        Name: ${self:service}-prod-ClientId

    CognitoIssuer:
      Description: Cognito Token Issuer URL
      Value:
        Fn::Sub: https://cognito-idp.${AWS::Region}.amazonaws.com/${CognitoUserPool}
      Export:
        Name: ${self:service}-prod-Issuer

    ApiEndpoint:
      Description: API Gateway endpoint URL
      Value:
        Fn::Sub: https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com
      Export:
        Name: ${self:service}-prod-ApiEndpoint
